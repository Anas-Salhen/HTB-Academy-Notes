# Security in Active Directory
AD can be considered insecure by design since its default state needs many hardening measures, settings and tools. When thinking about security we think about the CIA triad. At its core, AD leans more toward availability and confidentiality.  
<img width="2576" height="1526" alt="Pasted image 20250903144536" src="https://github.com/user-attachments/assets/9ebdcfc6-5d58-4194-b087-8641f389cac3" />  

## General Active Directory Hardening Measures
These can be considered the bare minimum for general AD security.

### LAPS
With [Microsoft Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) accounts can be set up to have their password rotated on a fixed interval (i.e., 12 hours, 24 hours, etc.). This free tool can be beneficial in reducing the impact of an individual compromised host in an AD environment.

### Audit Policy Settings (Logging and Monitoring)
The picture below shows the advanced audit policy window.  
<img width="1410" height="727" alt="Pasted image 20250903145256" src="https://github.com/user-attachments/assets/9aad154e-691d-4bed-8650-d5e42a1302a8" />  
Another thing is that it is worth familiarizing ourselves with Microsoft's [Audit Policy Recommendations](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/audit-policy-recommendations) to help detect compromise.
### Group Policy Security Settings
Group Policy Objects (GPOs) are virtual collections of policy settings that can be applied to specific users, groups, and computers at the OU level. Types of security policies include:
- [Account Policies](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/account-policies) - Manage how user accounts interact with the domain. These include the password policy, account lockout policy, and Kerberos-related settings such as the lifetime of Kerberos tickets
    
- [Local Policies](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-options) - These apply to a specific computer and include the security event audit policy, user rights assignments (user privileges on a host), and specific security settings such as the ability to install drivers, whether the administrator and guest accounts are enabled, renaming the guest and administrator accounts, preventing users from installing printers or using removable media, and a variety of network access and network security controls.
    
- [Software Restriction Policies](https://docs.microsoft.com/en-us/windows-server/identity/software-restriction-policies/software-restriction-policies) - Settings to control what software can be run on a host.
    
- [Application Control Policies](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control) - Settings to control which applications can be run by certain users/groups. This may include blocking certain users from running all executables, Windows Installer files, scripts, etc. Administrators use [AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview) to restrict access to certain types of applications and files. It is not uncommon to see organizations block access to CMD and PowerShell for users that do not require them for their day-to-day job.
    
- [Advanced Audit Policy Configuration](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/secpol-advanced-security-audit-policy-settings) - A variety of settings that can be adjusted to audit activities such as file access or modification, account logon/logoff, policy changes, privilege usage, and more.

### Update Management (SCCM/WSUS)
The [Windows Server Update Service (WSUS)](https://docs.microsoft.com/en-us/windows-server/administration/windows-server-update-services/get-started/windows-server-update-services-wsus) can be installed as a role on a Windows Server and can be used to minimize the manual task of patching Windows systems. System Center Configuration Manager (SCCM) is a paid solution that relies on the WSUS Windows Server role being installed and offers more features than WSUS on its own. These solutions ensure that patches are installed on time and no hosts are left behind.

### Group Managed Service Accounts (gMSA)
A gMSA is an account managed by the domain that offers a higher level of security than other types of service accounts for use with non-interactive applications, services, processes, and tasks that are run automatically but require credentials to run. They provide automatic password management with a 120 character password generated by the domain controller. The password is changed at a regular interval and does not need to be known by any user. It allows for credentials to be used across multiple hosts.

### Security Groups
Important in managing user privileges. Some built-in AD security groups:  
<img width="1349" height="736" alt="Pasted image 20250903145947" src="https://github.com/user-attachments/assets/98d8dafe-73f7-42e0-a556-a0d4f647caaf" />  

### Account Separation
Administrators must have two separate accounts. One for their day-to-day work and a second for any administrative tasks they must perform. This can help ensure that if a user's host is compromised (through a phishing attack, for example), the attacker would be limited to that host and would not obtain credentials for a highly privileged user.

### Password Complexity Policies + Passphrases + 2FA
An organization should consider implementing a password filter to disallow passwords containing the months or seasons of the year, the company name, and common words such as `password` and `welcome`. The minimum password length for standard users should be at least 12 characters and longer for administrators/service accounts. Another important security measure is the implementation of multi-factor authentication (MFA) for Remote Desktop Access to any host. This can help to limit lateral movement attempts that may rely on GUI access to a host.

Ideally, an organization should be using passphrases or large randomly generated passwords using an enterprise password manager.

### Limiting Domain Admin Account Usage
All-powerful Domain Admin accounts should only be used to log in to Domain Controllers.

### Periodically Auditing and Removing Stale Users and Objects
Unused accounts should be disabled.

### Auditing Permissions and Access
Organizations should periodically perform access control audits to ensure that users only have the level of access required for their day-to-day work.

### Using Restricted Groups
[Restricted Groups](https://social.technet.microsoft.com/wiki/contents/articles/20402.active-directory-group-policy-restricted-groups.aspx) allow for administrators to configure group membership via Group Policy.

### Limiting Server Roles
It is important not to install additional roles on sensitive hosts, such as installing the `Internet Information Server` (IIS) role on a Domain Controller. This would increase the attack surface of the Domain Controller. Other examples would be not hosting web applications on an Exchange mail server and separating web servers and database servers out to different hosts.

### Limiting Local Admin and RDP Rights
The amount of users with local admin rights and users who are allowed to RDP to other machines should be restricted on a need basis.

# Examining Group Policy
Every Windows host has a Local Group Policy editor to manage local settings. For our purposes, we will focus on Group Policy in a domain context.

## Group Policy Objects (GPOs)
A [Group Policy Object (GPO)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects) is a virtual collection of policy settings that can be applied to user(s) or computer(s). Every GPO has a unique name and is assigned a unique identifier (a GUID). They can be linked to a specific OU, domain, or site. A single GPO can be linked to multiple containers, and any container can have multiple GPOs applied to it. They can be applied to individual users, hosts, or groups by being applied directly to an OU.

Examples of things you can do with GPOs:
- Establishing different password policies for service accounts, admin accounts, and standard user accounts using separate GPOs
- Preventing the use of removable media devices (such as USB devices)
- Enforcing a screensaver with a password
- Restricting access to applications that a standard user may not need, such as cmd.exe and PowerShell
- Enforcing audit and logging policies
- Blocking users from running certain types of programs and scripts
- Deploying software across a domain
- Blocking users from installing unapproved software
- Displaying a logon banner whenever a user logs into a system
- Disallowing LM hash usage in the domain
- Running scripts when computers start/shutdown or when a user logs in/out of their machine

## GPO Order of Precedence
| **Level**                                  | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Local Group Policy`                       | The policies are defined directly to the host locally outside the domain. Any setting here will be overwritten if a similar setting is defined at a higher level.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `Site Policy`                              | Any policies specific to the Enterprise Site that the host resides in. Remember that enterprise environments can span large campuses and even across countries. So it stands to reason that a site might have its own policies to follow that could differentiate it from the rest of the organization. Access Control policies are a great example of this. Say a specific building or `site` performs secret or restricted research and requires a higher level of authorization for access to resources. You could specify those settings at the site level and ensure they are linked so as not to be overwritten by domain policy. This is also a great way to perform actions like printer and share mapping for users in specific sites. |
| `Domain-wide Policy`                       | Any settings you wish to have applied across the domain as a whole. For example, setting the password policy complexity level, configuring a Desktop background for all users, and setting a Notice of Use and Consent to Monitor banner at the login screen.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `Organizational Unit` (OU)                 | These settings would affect users and computers who belong to specific OUs. You would want to place any unique settings here that are role-specific. For example, the mapping of a particular share drive that can only be accessed by HR, access to specific resources like printers, or the ability for IT admins to utilize PowerShell and command-prompt.                                                                                                                                                                                                                                                                                                                                                                                   |
| `Any OU Policies nested within other OU's` | Settings at this level would reflect special permissions for objects within nested OUs. For example, providing Security Analysts a specific set of Applocker policy settings that differ from the standard IT Applocker settings.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
Group policy is processed from the top of the AD down to the object. The order is local policy (on the machine), site-level GPOs, domain-level GPOs then OU GPOs from parent to child. If multiple GPOs configure the same setting the last one applied wins. Also if a setting is configured in computer configuration and user configuration, computer configuration wins.

In case a single OU has multiple GPOs, they are processed based on link order. The GPO with the lowest link order is processed last.

It's also possible to enable the `Enforced` option on a GPO which forbids GPOs that will be processed after it at lower level OUs from overriding it.

You can also set the `block inheritance` option on an OU to to stop policies that are higher up from applying to it. If both `enforced` and `block inheritance` are set `enforced` wins.

## Group Policy Refresh Frequency
When a GPO is created settings don't apply right away. Windows performs policy updates every 90 minutes with a random offset of +/- 30 minutes for users and computers so anywhere from 60 to 120 minutes. This random offset exists to avoid overwhelming DCs by clients requesting group policy updates at once. However, policies that apply to DCs update every 5 minutes.

We can modify the refresh interval via Group Policy by clicking on `Computer Configuration --> Policies --> Administrative Templates --> System --> Group Policy` and selecting `Set Group Policy refresh interval for computers`. While it can be changed, it should not be set to occur too often, or it could cause network congestion leading to replication issues.

We could force the update to take place now using `gpupdate /force`.
