# Desktop Experience vs. Server Core
Windows Server Core is a minimalistic server environment containing only key server functionalities. As a result it has lower management requirements, a smaller attack surface, uses less memory than Desktop Experience which has a GUI (unlike Server Core). In Server Core all configuration is performed via the command-line, PowerShell, remote management with MMC or Remote Server Administration Tools (RSAT).

While Server Core aims to have a smaller footprint by lacking a GUI, some graphical programs are still supported, such as Registry Editor, Notepad, System Information, Windows Installer, Task Manager, and PowerShell. It also supports some Sysinternals suite tools such as Active Directory Explorer, Process Explorer, Process Monitor, and TCPView.

As of Windows Server 2019, Server Core or Desktop Experience must be selected at installation, and neither can be rolled back (i.e., converting Server Core to Desktop Experience). Once installed, the initial setup for Server Core can be done via `Sconfig`. `Sconfig` is used for performing a variety of common commands such as configuring networking, checking for/installing Windows updates, account management, configuring remote management, activating Windows, and more.

Some server apps can't run on Server Core like Microsoft Server Virtual Machine Manager 2019 (SCVMM), System Center Data Protection Manager 2019, SharePoint Server 2019, Project Server 2019.

## Comparison
| **Application**                    | **Server Core** | **Desktop Experience** |
| ---------------------------------- | --------------- | ---------------------- |
| Command prompt                     | Available       | Available              |
| Windows PowerShell/ Microsoft .NET | Available       | Available              |
| Regedit                            | Available       | Available              |
| Diskmgmt.msc                       | Not Available   | Available              |
| Server Manager                     | Not Available   | Available              |
| Mmc.exe                            | Not Available   | Available              |
| Eventvwr                           | Not Available   | Available              |
| Services.msc                       | Not Available   | Available              |
| Control Panel                      | Not Available   | Available              |
| Windows Explorer                   | Not Available   | Available              |
| Taskmgr                            | Available       | Available              |
| Internet Explorer or Edge          | Not Available   | Available              |
| Remote Desktop Services            | Available       | Available              |

# Windows Security
## Security Identifier (SID)
Each security principle in the system has a unique SID which is automatically generated by the system. So even if we have 2 identical users Windows can distinguish them based on their SIDs. SIDs are string values with different lengths, they are added to the user's access token to identify actions that he is authorized to take.

```powershell-session
PS C:\htb> whoami /user

USER INFORMATION
----------------

User Name           SID
=================== =============================================
ws01\bob S-1-5-21-674899381-4069889467-2080702030-1002
```
The SID is broken down into this pattern: `(SID)-(revision level)-(identifier-authority)-(subauthority1)-(subauthority2)-(etc)`

|**Number**|**Meaning**|**Description**|
|---|---|---|
|S|SID|Identifies the string as a SID.|
|1|Revision Level|To date, this has never changed and has always been `1`.|
|5|Identifier-authority|A 48-bit string that identifies the authority (the computer or network) that created the SID.|
|21|Subauthority1|This is a variable number that identifies the user's relation or group described by the SID to the authority that created it. It tells us in what order this authority created the user's account.|
|674899381-4069889467-2080702030|Subauthority2|Tells us which computer (or domain) created the number|
|1002|Subauthority3|The RID that distinguishes one account from another. Tells us whether this user is a normal user, a guest, an administrator, or part of some other group|
In an AD domain environment SID also includes the domain SID.

## Security Accounts Manager (SAM) and Access Control Entries (ACE)
SAM grants rights to a network to execute specific processes. The access rights themselves are managed by Access Control Entries (ACE) in Access Control Lists (ACL). The permissions to access a securable object are given by the security descriptor, classified into two types of ACLs: the Discretionary Access Control List (DACL) or System Access Control List (SACL).  

An integral part of authorization is access tokens, validated by the Local Security Authority (LSA).

## User Account Control (UAC)
It's a security feature that prevents malware from running or manipulating processes. It offers Admin Approval Mode which prevents installing software without admin approval.

The diagram below ([source](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works)) shows what’s really happening behind the scenes when UAC asks for your permission.  
While it may look technical, the key idea is that Windows checks whether the app needs admin rights, who is logged in, and how your UAC settings are configured.  
You don’t need to understand every detail yet — just know that this process is what protects your system from running unauthorized programs silently.  
<img width="2576" height="3808" alt="Pasted image 20250715204214" src="https://github.com/user-attachments/assets/b0ce88d5-2525-45fa-bb87-af9b531a6331" />


## Registry
The Registry is a critical database that stores low-level settings for the OS and some applications. It's divided into computer-specific data (i.e. hardware settings, system configs, etc.) and user-specific data (i.e. theme preferences). We can open the Registry Editor by typing regedit from the command-line or windows search.

It's organized in a tree structure that consists of main folders (root keys) in which subfolders (subkeys) with their entries/files (values) are located. Types of values that can be entered in a subkey:

|**Value**|**Type**|
|---|---|
|REG_BINARY|Binary data in any form.|
|REG_DWORD|A 32-bit number.|
|REG_DWORD_LITTLE_ENDIAN|A 32-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_DWORD in the Windows header files.|
|REG_DWORD_BIG_ENDIAN|A 32-bit number in big-endian format. Some UNIX systems support big-endian architectures.|
|REG_EXPAND_SZ|A null-terminated string that contains unexpanded references to environment variables (for example, "%PATH%"). It will be a Unicode or ANSI string depending on whether you use the Unicode or ANSI functions. To expand the environment variable references, use the [**ExpandEnvironmentStrings**](https://docs.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-expandenvironmentstringsa) function.|
|REG_LINK|A null-terminated Unicode string containing the target path of a symbolic link created by calling the [**RegCreateKeyEx**](https://docs.microsoft.com/en-us/windows/desktop/api/Winreg/nf-winreg-regcreatekeyexa) function with REG_OPTION_CREATE_LINK.|
|REG_MULTI_SZ|A sequence of null-terminated strings, terminated by an empty string (\0). The following is an example: _String1_\0_String2_\0_String3_\0_LastString_\0\0 The first \0 terminates the first string, the second to the last \0 terminates the last string, and the final \0 terminates the sequence. Note that the final terminator must be factored into the length of the string.|
|REG_NONE|No defined value type.|
|REG_QWORD|A 64-bit number.|
|REG_QWORD_LITTLE_ENDIAN|A 64-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_QWORD in the Windows header files.|
|REG_SZ|A null-terminated string. This will be either a Unicode or an ANSI string, depending on whether you use the Unicode or ANSI functions.|
<img width="1027" height="299" alt="Pasted image 20250716142713" src="https://github.com/user-attachments/assets/86eefc9d-9e8f-4c63-9743-f3cdb73524ad" />

Each folder under `Computer` is a key. All root keys start with `HKEY`. A key such as `HKEY-LOCAL-MACHINE` is abbreviated to `HKLM`. HKLM contains all settings relevant to the local system and it contains six subkeys: `SAM`, `SECURITY`, `SYSTEM`, `SOFTWARE`, `HARDWARE`, and `BCD`, loaded into memory at boot time (except `HARDWARE` which is dynamically loaded).

System registry files are stored in several locations in the OS. For example, HKLM is stored in `C:\Windows\System32\Config\` and HKCU is stored in `C:\Users\<USERNAME>\Ntuser.dat`.

### Run and RunOnce
These are Registry keys (some might call them subkeys) responsible for starting applications when the system first boots. They are 4 in total:
1. `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`: Runs every time the system boots
2. `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`: Runs every time that user logs in
3. `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce`: Runs only once at next boot
4. `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`: Runs only once at next login
Each of these keys contain string values which are the paths to the programs to be executed at startup.

## Application Whitelisting
An application whitelist is a list of applications that are allowed to exist and run on our system. Implementing an enforced whitelist (in which non-whitelisted apps are blocked) in a large network can be a challenge which is why an organization should implement a whitelist in audit mode before enforced mode.

A blacklist is the opposite and it contains a list of harmful software that is blocked. However, a whitelist generally has less overhead since you only specify what's allowed instead of a blacklist that needs to be updated for every new malware.

Whitelisting is based on the zero trust principle and it's recommended by organizations such as [NIST](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-167.pdf), especially in high-security environments.

### AppLocker
A whitelisting solution first introduced in Windows 7. It allows for creating rules based on file attributes such as the publisher's name (which can be derived from the digital signature), product name, file name, and version. Rules can also be set up based on file paths and hashes. Rules can be applied to either security groups or individual users, based on the business need. It also supports audit mode.

## Local Group Policy
Group Policy is a centralized way for admins to set and configure settings. In a domain environment these policies are pushed from a Domain Controller to all machines within that domain.

Local Group Policy allows doing that on an individual computer (not a whole domain). It's useful to tweak certain graphical and network settings that are otherwise not accessible via the Control Panel. We can open the Local Group Policy Editor by typing `gpedit.msc` in the start menu. It's split into Computer Configuration and User Configuration.  
<img width="1629" height="536" alt="Pasted image 20250716181031" src="https://github.com/user-attachments/assets/de86b73c-6daf-4ba2-9905-69673a8db92a" />


## Windows Defender Antivirus
Formerly known as Windows Defender, it's a built-in antivirus that comes for free with the Windows OS. It comes with several security features such as real-time protection, cloud-delivered protection and tamper protection which prevents security settings from being changed through the Registry, PowerShell cmdlets, or group policy.

Windows Defender Antivirus is managed from the Security Centre. There are many things that can be tweaked like adding files/folders to an exclusion list so they aren't scanned like pentesting tools since they will be considered malicious.  
We can use the PowerShell cmdlet `Get-MpComputerStatus` to check which protection settings are enabled.
